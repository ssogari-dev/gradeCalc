<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„í”Œë© ë£°ë › ë¶„ì„</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.datatables.net/2.0.1/css/dataTables.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/2.0.1/js/dataTables.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        :root { 
            --primary: #6366f1; /* Indigo */
            --primary-dark: #4f46e5;
            --secondary: #ec4899; /* Pink */
            --bg: #f3f4f6; 
            --card-bg: #ffffff; 
            --text: #1f2937; 
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            line-height: 1.6;
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding-bottom: 40px;
        }
        
        /* Header */
        header { 
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        /* Header Buttons */
        .btn-icon {
            width: 40px; height: 40px; 
            border-radius: 50%; 
            border: 1px solid transparent;
            background: transparent; 
            color: var(--text-light); 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
        }
        .btn-icon:hover { background: #f3f4f6; color: var(--primary); transform: scale(1.05); }
        
        .btn-outline {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            color: var(--text);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #eef2ff; }
        
        h1 { 
            color: var(--text); 
            font-weight: 800; 
            margin: 0; 
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1 i { color: var(--primary); }
        
        /* Upload Section Layout */
        .upload-section { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 24px; }
        @media (max-width: 768px) { .upload-section { grid-template-columns: 1fr; } }

        /* Upload Zone */
        .upload-area {
            border: 2px dashed #cbd5e1; 
            border-radius: var(--radius); 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 15px;
            background: var(--card-bg); 
            transition: all 0.3s ease; 
            cursor: pointer; 
            box-shadow: var(--shadow-sm);
            height: 220px; /* ë†’ì´ ê³ ì • */
            box-sizing: border-box;
        }
        .upload-area:hover, .upload-area.dragover { 
            border-color: var(--primary); 
            background: #eef2ff; 
            transform: scale(1.005);
        }
        .upload-icon { font-size: 40px; color: var(--primary); opacity: 0.8; margin-bottom: 0; }
        .upload-area h3 { margin: 0; color: var(--text); font-size: 18px; }
        .upload-area p { margin: 0; color: var(--text-light); font-size: 14px; }
        
        /* File List Box */
        .file-manage-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
            height: 220px; /* ë†’ì´ ê³ ì • (ì—…ë¡œë“œ ë°•ìŠ¤ì™€ í†µì¼) */
            box-sizing: border-box;
        }
        .file-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .file-box-title { font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .file-list-container { 
            flex: 1; overflow-y: auto; 
            /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
            scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;
        }
        .file-list-container::-webkit-scrollbar { width: 6px; }
        .file-list-container::-webkit-scrollbar-track { background: transparent; }
        .file-list-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        
        .file-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 6px; 
            border: 1px solid #f3f4f6; transition: 0.2s; cursor: pointer;
        }
        .file-item:hover { background: #fff; border-color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .file-info { display: flex; align-items: center; gap: 10px; overflow: hidden; flex: 1; }
        .file-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .file-size { font-size: 11px; color: var(--text-light); }
        .btn-del-file { 
            color: #ef4444; background: none; border: none; cursor: pointer; 
            padding: 4px 8px; border-radius: 4px; transition: 0.2s;
        }
        .btn-del-file:hover { background: #fee2e2; }
        
        /* Controls */
        .controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            flex-wrap: wrap;
            gap: 16px;
        }
        .filter-group { display: flex; gap: 12px; align-items: center; }
        .filter-group label { color: var(--text-light); font-size: 14px; }
        
        select, input[type="text"] { 
            padding: 10px 14px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            font-size: 14px; 
            font-family: inherit;
            background: #fff;
            transition: border-color 0.2s;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: var(--primary); ring: 2px solid #e0e7ff; }
        select { min-width: 240px; }
        input[type="text"] { width: 220px; }
        
        .btn-reset { 
            background: #ef4444; color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; cursor: pointer; 
            font-weight: 600; transition: background 0.2s; 
            display: flex; align-items: center; gap: 6px;
        }
        .btn-reset:hover { background: #dc2626; }
        
        /* Stats Cards */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card h3 { margin: 0 0 12px 0; font-size: 14px; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .value { font-size: 32px; font-weight: 800; color: var(--text); line-height: 1.2; }
        .card::after {
            content: ''; position: absolute; top: 0; right: 0; width: 80px; height: 80px;
            background: linear-gradient(135deg, transparent 50%, rgba(99, 102, 241, 0.05) 50%);
        }
        
        .text-green { color: #10b981 !important; }
        .text-red { color: #ef4444 !important; }
        .text-primary { color: var(--primary) !important; }
        
        /* Tabs */
        .tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            padding-bottom: 5px;
        }
        .tab-btn { 
            padding: 10px 20px; 
            border: none; 
            background: transparent; 
            font-weight: 600; 
            color: var(--text-light); 
            cursor: pointer; 
            border-radius: 99px; 
            transition: all 0.2s; 
            font-size: 15px; 
            white-space: nowrap;
            display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { background: rgba(0,0,0,0.05); color: var(--text); }
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.25);
        }
        .tab-btn.viewer-tab { margin-left: auto; background: #1f2937; color: #fbbf24; }
        .tab-btn.viewer-tab.active { background: #f59e0b; color: black; }
        
        .tab-content { 
            display: none; 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-lg); 
            min-height: 400px;
        }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        
        /* Charts */
        .charts-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
            width: 100%;
        }
        .chart-wrapper {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            min-width: 0; /* Grid overflow fix */
            display: flex; flex-direction: column;
        }
        .chart-wrapper.full-width { grid-column: 1 / -1; }
        .chart-title {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: var(--text);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-canvas-box { 
            position: relative; 
            width: 100%; 
            height: 350px; /* ê¸°ë³¸ ë†’ì´ */
        }
        
        /* Responsive Charts */
        @media (max-width: 1000px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* Tables Customization */
        table.dataTable { width: 100% !important; font-size: 14px; border-collapse: separate; border-spacing: 0; }
        table.dataTable thead th { 
            background-color: #f9fafb; 
            border-bottom: 2px solid var(--border) !important; 
            font-weight: 700; 
            color: var(--text); 
            padding: 16px 12px; 
            text-align: left;
        }
        table.dataTable td { 
            padding: 14px 12px; 
            vertical-align: middle; 
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }
        table.dataTable tr:last-child td { border-bottom: none; }
        table.dataTable tbody tr:hover { background-color: #f9fafb; }
        
        .badge { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; }
        .bg-green { background: #d1fae5; color: #065f46; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        
        /* Win Items */
        .win-container { display: flex; flex-wrap: wrap; gap: 6px; max-width: 100%; }
        .win-badge { 
            display: inline-flex; align-items: center; 
            background: #f3e8ff; border: 1px solid #e9d5ff; 
            border-radius: 6px; padding: 4px 8px; font-size: 13px; color: #6b21a8; 
        }
        .win-badge .count { 
            background: #9333ea; color: white; border-radius: 99px; 
            padding: 1px 6px; font-size: 11px; margin-left: 6px; font-weight: 700;
        }
        
        /* DataTables Custom UI */
        .dataTables_wrapper .dataTables_filter input { 
            padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; margin-left: 8px;
        }
        .dataTables_wrapper .dataTables_length select {
            padding: 6px 24px 6px 10px; border: 1px solid var(--border); border-radius: 6px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background: var(--primary) !important; color: white !important; border: none; border-radius: 6px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #e0e7ff !important; border: none; border-radius: 6px; color: var(--primary) !important;
        }

        /* Tooltip Styles */
        [data-tooltip] { position: relative; cursor: help; }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%; left: 50%;
            transform: translateX(-50%);
            background: #1f2937; 
            color: #fff;
            padding: 6px 10px; 
            border-radius: 6px;
            font-size: 12px; 
            white-space: nowrap; 
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 6px;
            opacity: 0; animation: fadeInTooltip 0.2s forwards;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%; left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
            margin-bottom: -4px; /* Arrow spacing */
            opacity: 0; animation: fadeInTooltip 0.2s forwards;
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        /* Viewer Tab Specifics (Clean Layout) */
        #tab-viewer .win-badge { cursor: pointer; transition: transform 0.1s; }
        #tab-viewer .win-badge:hover { transform: scale(1.05); border-color: var(--primary); }
        #tab-viewer .user-nick { font-size: 16px; font-weight: 700; color: var(--text); margin-right: 6px; }
        #tab-viewer .user-id { font-size: 13px; color: var(--text-light); }

        #loading { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); 
            z-index:9999; flex-direction: column; justify-content: center; align-items: center; 
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px);
            justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content {
            background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 600px;
            box-shadow: var(--shadow-lg); max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 18px; font-weight: 800; color: var(--text); }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); transition: color 0.2s; }
        .modal-close:hover { color: var(--text); }
        .detail-list { list-style: none; padding: 0; margin: 0; }
        .detail-item { 
            padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; 
        }
        .detail-item:last-child { border-bottom: none; }
        .detail-time { font-weight: 600; color: var(--text); display: block; margin-bottom: 4px; }
        .detail-source { font-size: 12px; color: var(--text-light); background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }

        /* Matrix Table Styles */
        .matrix-container { overflow-x: auto; max-height: 600px; border: 1px solid var(--border); border-radius: 8px; }
        .matrix-table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 13px; text-align: center; }
        .matrix-table th, .matrix-table td { border: 1px solid #e5e7eb; padding: 8px 12px; color: var(--text); }
        .matrix-table thead th { background: #f9fafb; position: sticky; top: 0; z-index: 10; font-weight: 700; color: var(--text-light); }
        .matrix-table tbody th { background: #f9fafb; position: sticky; left: 0; z-index: 5; font-weight: 600; text-align: left; color: var(--text); }
        
        /* í•©ê³„ ê°•ì¡° ìŠ¤íƒ€ì¼ (ê¹”ë”í•œ í†¤) */
        .matrix-table .total-cell { background: #eef2ff; color: var(--primary-dark); font-weight: 700; }
        .matrix-table tr:last-child td, .matrix-table tr:last-child th { 
            background: #eef2ff; color: var(--primary-dark); font-weight: 700; position: sticky; bottom: 0; z-index: 10; border-top: 2px solid #c7d2fe;
        }
        
        /* ì™¼ìª½ ìƒë‹¨ ê³ ì • (êµì°¨ì ) */
        .matrix-table thead th:first-child { position: sticky; left: 0; z-index: 20; border-right: 2px solid #e5e7eb; background: #f3f4f6; }
        /* ë§ˆì§€ë§‰ ì»¬ëŸ¼(í•©ê³„) ìŠ¤íƒ€ì¼ */
        .matrix-table td:last-child, .matrix-table th:last-child { border-left: 2px solid #e5e7eb; }

        /* Viewer Sub Tabs */
        .viewer-controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .viewer-sub-tabs { display: flex; gap: 4px; background: #f3f4f6; padding: 4px; border-radius: 8px; }
        .sub-tab-btn {
            border: none; background: none; padding: 6px 12px; font-size: 13px; font-weight: 600; color: #6b7280; 
            cursor: pointer; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .sub-tab-btn:hover { color: var(--text); }
        .sub-tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Blur Settings CSS */
        body.blur-global-star #val-star,
        body.blur-global-star #val-star-total { filter: blur(12px); user-select: none; }
        
        body.blur-global-count #val-total, 
        body.blur-global-count #val-match, 
        body.blur-global-count #val-miss { filter: blur(8px); user-select: none; }

        body.blur-table-star .col-star { filter: blur(5px); user-select: none; }
        body.blur-table-count .col-count { filter: blur(5px); user-select: none; }
        body.blur-item-count .win-badge .count { filter: blur(4px); user-select: none; }

        /* Toggle Switch */
        .switch-group { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .switch-group:last-child { border-bottom: none; }
        .switch-label { font-weight: 600; color: var(--text); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-cog"></i> í™”ë©´ í‘œì‹œ ì„¤ì •</div>
            <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div style="padding: 10px 0;">
            <div class="switch-group">
                <span class="switch-label">ì´ ëˆ„ì  ë³„í’ì„  ìˆ¨ê¸°ê¸°</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleBlur('global-star', this)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-group">
                <span class="switch-label">ì´ ë£°ë › íšŸìˆ˜ ìˆ¨ê¸°ê¸°</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleBlur('global-count', this)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-group">
                <span class="switch-label">ëª©ë¡ ë‚´ ë³„í’ì„  ìˆ˜ëŸ‰ ìˆ¨ê¸°ê¸°</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleBlur('table-star', this)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-group">
                <span class="switch-label">ëª©ë¡ ë‚´ íšŸìˆ˜ ìˆ¨ê¸°ê¸°</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleBlur('table-count', this)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-group">
                <span class="switch-label">í•­ëª©ë³„ íšŸìˆ˜(ë±ƒì§€) ìˆ¨ê¸°ê¸°</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleBlur('item-count', this)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modal-title">ìƒì„¸ ë‚´ì—­</div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <ul id="modal-list" class="detail-list">
            <!-- JSë¡œ ì±„ì›Œì§ -->
        </ul>
    </div>
</div>

<div id="loading">
    <div style="text-align: center;">
        <div class="spinner" style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <h3 style="color: var(--text); margin: 0;">ë°ì´í„° ë¶„ì„ ì¤‘...</h3>
        <p style="color: var(--text-light); font-size: 14px; margin-top: 8px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>
</div>

<style>@keyframes spin { to { transform: rotate(360deg); } }</style>

<div class="container">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="width: 48px; height: 48px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);">
                <i class="fas fa-chart-pie fa-lg" style="color: white;"></i>
            </div>
            <div>
                <h1 style="font-size: 22px; margin-bottom: 4px;">SOOP / Weflab ë£°ë › ë¶„ì„ê¸°</h1>
                <span style="font-size: 13px; color: var(--text-light); font-weight: 500;">ë°ì´í„° ê¸°ë°˜ ë£°ë › ë° ë³„í’ì„  í†µê³„ ëŒ€ì‹œë³´ë“œ</span>
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items: center;">
            <button class="btn-icon" onclick="openSettingsModal()" title="í™”ë©´ ì„¤ì •">
                <i class="fas fa-cog"></i>
            </button>
            <button class="btn-outline" onclick="openToolModal()">
                <i class="fas fa-download"></i> í•„ìˆ˜ ë„êµ¬
            </button>
        </div>
    </header>

    <div class="upload-section">
        <div class="upload-area" id="drop-zone">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <div>
                <h3>CSV íŒŒì¼ ì—…ë¡œë“œ</h3>
                <p style="margin-top: 5px;">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”.<br><span style="font-size: 12px; color: #9ca3af;">(ì§€ì› í˜•ì‹: .csv)</span></p>
            </div>
            <input type="file" id="file-input" multiple accept=".csv" style="display:none">
        </div>
        
        <div class="file-manage-box">
            <div class="file-box-header">
                <div class="file-box-title"><i class="fas fa-folder-open"></i> íŒŒì¼ ëª©ë¡ <span id="file-count-badge" class="badge bg-green" style="margin-left:5px; display:none;">0</span></div>
                <button onclick="resetData()" style="font-size: 12px; color: #666; background: none; border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ì „ì²´ ì‚­ì œ</button>
            </div>
            <div id="file-list-container" class="file-list-container">
                <div style="text-align:center; color:#9ca3af; font-size:13px; padding-top: 50px;">
                    <i class="fas fa-inbox" style="font-size:24px; margin-bottom:8px; display:block;"></i>
                    ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <div class="controls" id="controls" style="display:none;">
        <div class="filter-group">
            <label for="broadcast-select"><i class="fas fa-filter"></i> ë°©ì†¡ í•„í„°</label>
            <select id="broadcast-select" onchange="applyFilter()">
                <option value="all">ì „ì²´ ë°©ì†¡ í•©ì‚°</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="exclude-input"><i class="fas fa-eye-slash"></i> ë·°ì–´ ì œì™¸ í‚¤ì›Œë“œ</label>
            <input type="text" id="exclude-input" placeholder="ì˜ˆ: ê½, ë‹¤ìŒê¸°íšŒì—" onchange="applyFilter()">
        </div>
        <div style="margin-left: auto;">
            <button class="btn-reset" onclick="resetData()"><i class="fas fa-redo-alt"></i> ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="dashboard" style="display:none;">
        
        <div class="stats-grid" id="stats-panel">
            <div class="card">
                <h3><i class="fas fa-dice"></i> ì´ ë£°ë › íšŸìˆ˜</h3>
                <div class="value" id="val-total">0</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-check-circle text-green"></i> ë§¤ì¹­ ì™„ë£Œ</h3>
                <div class="value text-green" id="val-match">0</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-exclamation-triangle text-red"></i> ë¯¸ë§¤ì¹­ (í™•ì¸í•„ìš”)</h3>
                <div class="value text-red" id="val-miss">0</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-star text-primary"></i> ë£°ë › ë³„í’ì„ </h3>
                <div class="value text-primary" id="val-star">0</div>
                <div id="val-star-total" style="font-size: 12px; color: var(--text-light); margin-top: 8px; font-weight: 500;">
                    ì „ì²´ ìˆ˜ì§‘: 0
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-user')"><i class="fas fa-user-friends"></i> ì‚¬ìš©ìë³„ ë¶„ì„</button>
            <button class="tab-btn" onclick="switchTab('tab-broadcast')"><i class="fas fa-broadcast-tower"></i> ë°©ì†¡ë³„ í†µê³„</button>
            <button class="tab-btn" onclick="switchTab('tab-prize')"><i class="fas fa-gift"></i> ì „ì²´ ë‹¹ì²¨ í†µê³„</button>
            <button class="tab-btn" onclick="switchTab('tab-chart')"><i class="fas fa-chart-pie"></i> ì°¨íŠ¸</button>
            <button class="tab-btn" onclick="switchTab('tab-list')"><i class="fas fa-list"></i> ë¡œê·¸</button>
            <button class="tab-btn viewer-tab" onclick="switchTab('tab-viewer')"><i class="fas fa-tv"></i> ë°©ì†¡ìš© ë·°ì–´</button>
        </div>

        <div id="tab-user" class="tab-content active">
            <table id="table-user" class="display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th width="5%">ìˆœìœ„</th>
                        <th width="10%">ë‹‰ë„¤ì„</th>
                        <th width="10%">ì•„ì´ë””</th>
                        <th width="8%">íšŸìˆ˜</th>
                        <th width="10%">ì´ ë³„í’ì„ </th>
                        <th>ë‹¹ì²¨ í•­ëª© (ìƒì„¸)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-broadcast" class="tab-content">
            <table id="table-broadcast" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>ë°©ì†¡ ì†ŒìŠ¤ (íŒŒì¼ëª…)</th>
                        <th>ì´ ë£°ë › íšŸìˆ˜</th>
                        <th>ì°¸ì—¬ ì‚¬ìš©ì ìˆ˜</th>
                        <th>ë£°ë › ë³„í’ì„ </th>
                        <th>ì „ì²´ ë³„í’ì„ </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-prize" class="tab-content">
            <table id="table-prize" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ë‹¹ì²¨ ìƒí’ˆëª…</th>
                        <th>ë‹¹ì²¨ íšŸìˆ˜</th>
                        <th>ì ìœ ìœ¨(%)</th>
                        <th>ëˆ„ì  ë³„í’ì„ </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-chart" class="tab-content">
            <div class="charts-grid">
                <div class="chart-wrapper">
                    <h4 class="chart-title"><i class="fas fa-chart-pie"></i> ë‹¹ì²¨ ë¹„ìœ¨ (Top 10)</h4>
                    <div class="chart-canvas-box">
                        <canvas id="chart-pie"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <h4 class="chart-title"><i class="fas fa-history"></i> ì‹œê°„ëŒ€ë³„ ì°¸ì—¬ ì¶”ì´</h4>
                    <div class="chart-canvas-box">
                        <canvas id="chart-line"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper full-width">
                    <h4 class="chart-title"><i class="fas fa-list-ol"></i> ë‹¹ì²¨ í•­ëª©ë³„ ë¹ˆë„ (ìƒì„¸)</h4>
                    <div class="chart-canvas-box">
                        <canvas id="chart-bar"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-list" class="tab-content">
            <table id="table-detail" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>ìƒíƒœ</th>
                        <th>ì‹œê°„</th>
                        <th>ë‹‰ë„¤ì„</th>
                        <th>ì•„ì´ë””</th>
                        <th>ê°œìˆ˜</th>
                        <th>ë‹¹ì²¨ ê²°ê³¼</th>
                        <th>ë°©ì†¡(íŒŒì¼ëª…)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-viewer" class="tab-content">
            <div class="viewer-controls-header">
                <div style="color:#666; font-size:13px;">
                    <i class="fas fa-info-circle"></i> ë‹‰ë„¤ì„ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬ | ì œì™¸ í•„í„° ì ìš©ë¨ | ìˆœìœ„/ê¸ˆì•¡ ìˆ¨ê¹€
                </div>
                <div class="viewer-sub-tabs">
                    <button class="sub-tab-btn active" onclick="switchViewerMode('list', this)">
                        <i class="fas fa-list"></i> ëª©ë¡í˜•
                    </button>
                    <button class="sub-tab-btn" onclick="switchViewerMode('matrix', this)">
                        <i class="fas fa-th"></i> ì§‘ê³„í‘œí˜•
                    </button>
                </div>
            </div>

            <div id="viewer-view-list">
                <table id="table-viewer" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th width="20%">ì°¸ì—¬ì</th>
                            <th>ë‹¹ì²¨ ëª©ë¡</th>
                            <th>ë‹‰ë„¤ì„(ìˆ¨ê¹€)</th> </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="viewer-view-matrix" style="display:none;">
                <div class="matrix-container">
                    <table id="matrix-table" class="matrix-table">
                        <!-- JSë¡œ ë™ì  ìƒì„± -->
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="tool-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-tools"></i> ë°ì´í„° ì¶”ì¶œ ë„êµ¬ ì•ˆë‚´</div>
            <button class="modal-close" onclick="closeToolModal()">&times;</button>
        </div>
        <div style="padding: 10px 0;">
            <p style="margin-top:0; color: var(--text); line-height: 1.6;">
                ë³¸ ë¶„ì„ ì‚¬ì´íŠ¸ëŠ” <strong>ì˜ê°€ë¦¬ ìŠ¤íŠœë””ì˜¤(SSoGari Studio)</strong>ì—ì„œ ì œê³µí•˜ëŠ”<br>
                ì „ìš© ë°ì´í„° ì¶”ì¶œê¸°ë¥¼ í†µí•´ ìƒì„±ëœ CSV íŒŒì¼ë¥¼ ë¶„ì„í•˜ê¸° ìœ„í•´ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
            </p>
            <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin:0 0 10px 0; color: var(--primary);">ğŸ“Œ í•„ìˆ˜ ìœ ì €ìŠ¤í¬ë¦½íŠ¸</h4>
                <ul style="margin:0; padding-left: 20px; color: var(--text-light); font-size: 14px;">
                    <li style="margin-bottom: 5px;"><strong>SOOP VOD ë³„í’ì„  ë‚´ì—­ ì¶”ì¶œê¸°</strong></li>
                    <li><strong>ìœ„í”Œë© ë£°ë › ë‚´ì—­ ì¶”ì¶œê¸°</strong></li>
                </ul>
            </div>
            <p style="font-size: 13px; color: #666;">
                ì•„ë˜ ë§í¬ì—ì„œ Tampermonkeyìš© ìœ ì €ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.
            </p>
            <a href="https://github.com/ssogari-dev/streamer-tools/tree/main/UserScript" target="_blank" 
               style="display: block; text-align: center; background: var(--primary); color: white; text-decoration: none; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 15px;">
                <i class="fab fa-github"></i>ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ ì´ë™
            </a>
        </div>
    </div>
</div>

<div id="preview-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-file-csv"></i> íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° <span id="preview-filename" style="font-size:14px; color:#666; font-weight:normal; margin-left:10px;"></span></div>
            <button class="modal-close" onclick="closePreviewModal()">&times;</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="preview-table" class="dataTable" style="width:100%; font-size:12px;">
                <thead id="preview-thead"></thead>
                <tbody id="preview-tbody"></tbody>
            </table>
        </div>
        <div style="margin-top: 15px; text-align: right; font-size: 12px; color: #666;">
            * ìƒìœ„ 5ê°œ í–‰ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<script>
    // --- Global Variables ---
    let globalWeflab = [];
    let globalSoop = [];
    let loadedFiles = new Set(); // íŒŒì¼ëª… ì¤‘ë³µ ì²´í¬ìš©
    let fileMetaMap = {}; // íŒŒì¼ ë©”íƒ€ë°ì´í„° (ì‚¬ì´ì¦ˆ ë“±)
    
    const koreanLang = {
        "decimal": "", "emptyTable": "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤", "info": "_START_ - _END_ (ì´ _TOTAL_ ê±´)", 
        "infoEmpty": "0ê±´", "infoFiltered": "(ì „ì²´ _MAX_ ê±´ ì¤‘ ê²€ìƒ‰)", "lengthMenu": "_MENU_ ê±´ì”© ë³´ê¸°", 
        "search": "ê²€ìƒ‰:", "zeroRecords": "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ", 
        "paginate": { "first": "ì²˜ìŒ", "last": "ë§ˆì§€ë§‰", "next": "ë‹¤ìŒ", "previous": "ì´ì „" }
    };

    // --- Events ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    // --- Logic ---
    function resetData() {
        if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        globalWeflab = []; globalSoop = []; loadedFiles.clear(); fileMetaMap = {};
        updateFileListUI();
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('controls').style.display = 'none';
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        document.getElementById('loading').style.display = 'flex';
        
        let newCount = 0;
        const promises = Array.from(files).map(file => {
            if (loadedFiles.has(file.name)) return Promise.resolve();
            loadedFiles.add(file.name);
            // ë©”íƒ€ë°ì´í„° ì´ˆê¸°í™”
            fileMetaMap[file.name] = { size: file.size, previewData: [] };
            newCount++;
            return new Promise((resolve) => {
                Papa.parse(file, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => { 
                        // ì›ë³¸ ë°ì´í„° ìƒìœ„ 5ê°œ ì €ì¥ (ë¯¸ë¦¬ë³´ê¸°ìš©)
                        if (results.data && results.data.length > 0) {
                            fileMetaMap[file.name].previewData = results.data.slice(0, 5);
                        }
                        processData(results.data, file.name); 
                        resolve(); 
                    }
                });
            });
        });

        await Promise.all(promises);
        
        if (newCount > 0) {
            updateFileListUI();
            updateUI();
            applyFilter();
        }
        document.getElementById('loading').style.display = 'none';
        // input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
        document.getElementById('file-input').value = '';
    }

    // íŒŒì¼ ëª©ë¡ UI ì—…ë°ì´íŠ¸
    function updateFileListUI() {
        const container = document.getElementById('file-list-container');
        const badge = document.getElementById('file-count-badge');
        const files = Array.from(loadedFiles);
        
        badge.innerText = files.length;
        badge.style.display = files.length > 0 ? 'inline-block' : 'none';

        if (files.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:#9ca3af; font-size:13px; padding-top: 30px;">
                    <i class="fas fa-inbox" style="font-size:20px; margin-bottom:5px; display:block;"></i>
                    íŒŒì¼ ì—†ìŒ
                </div>`;
            return;
        }

        container.innerHTML = '';
        files.forEach(name => {
            const size = fileMetaMap[name] ? formatBytes(fileMetaMap[name].size) : '-';
            const div = document.createElement('div');
            div.className = 'file-item';
            // í´ë¦­ ì‹œ ë¯¸ë¦¬ë³´ê¸° (ì‚­ì œ ë²„íŠ¼ ì œì™¸)
            div.onclick = (e) => {
                if(!e.target.closest('.btn-del-file')) showFilePreview(name);
            };
            
            div.innerHTML = `
                <div class="file-info">
                    <i class="fas fa-file-csv" style="color: #10b981;"></i>
                    <div style="overflow:hidden;">
                        <div class="file-name" title="${name} (í´ë¦­í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°)">${name}</div>
                        <div class="file-size">${size}</div>
                    </div>
                </div>
                <button class="btn-del-file" onclick="removeFile('${name}')" title="ì‚­ì œ">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(div);
        });
    }

    // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
    window.showFilePreview = function(filename) {
        // ì›ë³¸ ë°ì´í„° ìƒ˜í”Œ ê°€ì ¸ì˜¤ê¸°
        const meta = fileMetaMap[filename];
        if (!meta || !meta.previewData || meta.previewData.length === 0) {
            alert('ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const samples = meta.previewData;

        document.getElementById('preview-filename').innerText = filename;
        const thead = document.getElementById('preview-thead');
        const tbody = document.getElementById('preview-tbody');
        
        // ëª¨ë“  ìƒ˜í”Œ í–‰ì„ ìˆœíšŒí•˜ë©° ìœ ë‹ˆí¬í•œ í‚¤ ìˆ˜ì§‘ (í—¤ë” ëˆ„ë½ ë°©ì§€)
        const allKeys = new Set();
        samples.forEach(row => {
            Object.keys(row).forEach(k => allKeys.add(k));
        });
        const keys = Array.from(allKeys);
        
        thead.innerHTML = '<tr>' + keys.map(k => `<th style="white-space:nowrap;">${k}</th>`).join('') + '</tr>';
        
        // ë°”ë”” ìƒì„±
        tbody.innerHTML = samples.map(row => {
            return '<tr>' + keys.map(k => {
                let val = row[k] !== undefined ? row[k] : '';
                return `<td style="white-space:nowrap;">${val}</td>`;
            }).join('') + '</tr>';
        }).join('');

        document.getElementById('preview-modal').classList.add('active');
    };

    window.closePreviewModal = function() {
        document.getElementById('preview-modal').classList.remove('active');
    };
    
    document.getElementById('preview-modal').addEventListener('click', function(e) {
        if(e.target === this) closePreviewModal();
    });

    // ê°œë³„ íŒŒì¼ ì‚­ì œ
    window.removeFile = function(filename) {
        if(!confirm(`'${filename}' íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        // 1. ë°ì´í„° ì‚­ì œ
        globalWeflab = globalWeflab.filter(d => d.source !== filename);
        globalSoop = globalSoop.filter(d => d.source !== filename);
        loadedFiles.delete(filename);
        delete fileMetaMap[filename];
        
        // 2. UI ê°±ì‹ 
        updateFileListUI();
        
        // ë°ì´í„°ê°€ ë‹¤ ì‚¬ë¼ì§€ë©´ ëŒ€ì‹œë³´ë“œ ìˆ¨ê¹€
        if (loadedFiles.size === 0) {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
        } else {
            updateUI(); // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°±ì‹ 
            applyFilter(); // ì°¨íŠ¸ ë° í…Œì´ë¸” ê°±ì‹ 
        }
    };

    function formatBytes(bytes, decimals = 1) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function processData(data, filename) {
        if (!data || data.length === 0) return;
        const headers = Object.keys(data[0]);

        if (headers.includes('ë‹¹ì²¨ê²°ê³¼') || headers.includes('win_result')) {
            data.forEach(row => {
                // weflab-roulette.user.js ì¶”ì¶œ íŒŒì¼ í˜¸í™˜ì„± ê°•í™”
                // '1íšŒë‹¹ë³„í’ì„ 'ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš© (ê°œë³„ ì‹œí–‰ ë¹„ìš©)
                // ì—†ìœ¼ë©´ 'ë³„í’ì„ ', 'ì´ë³„í’ì„ ', 'Count' ìˆœìœ¼ë¡œ ì°¾ìŒ
                let countVal = 0;
                if (row['1íšŒë‹¹ë³„í’ì„ '] && row['1íšŒë‹¹ë³„í’ì„ '] !== "") {
                    countVal = parseInt(row['1íšŒë‹¹ë³„í’ì„ ']);
                } else {
                    countVal = parseInt(row['ë³„í’ì„ '] || row['ì´ë³„í’ì„ '] || row['Count'] || 0);
                }

                globalWeflab.push({
                    time: new Date(row['ì‹œê°„'] || row['Time']),
                    nick: row['ë‹‰ë„¤ì„'] || row['Nickname'],
                    id: row['ì•„ì´ë””'] || row['ID'],
                    count: countVal,
                    result: row['ë‹¹ì²¨ê²°ê³¼'] || row['win_result'],
                    source: filename 
                });
            });
        } else if (headers.includes('ì‹¤ì œì‹œê°„') || headers.includes('RealTime')) {
            data.forEach(row => {
                let tStr = row['ì‹¤ì œì‹œê°„'] || row['RealTime'];
                if(tStr) tStr = tStr.replace(/\./g, '-');
                globalSoop.push({
                    time: new Date(tStr),
                    nick: row['ë‹‰ë„¤ì„'] || row['Nickname'],
                    id: row['ì•„ì´ë””'] || row['UserID'] || row['ID'],
                    count: parseInt(row['ê°œìˆ˜'] || row['Amount'] || row['Count'] || 0),
                    source: filename
                });
            });
        }
    }

    function updateUI() {
        // document.getElementById('uploaded-files').innerText = ... (Deprecated)
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('controls').style.display = 'flex';
        
        const select = document.getElementById('broadcast-select');
        const currentVal = select.value;
        const sources = [...new Set(globalSoop.map(d => d.source))];
        select.innerHTML = '<option value="all">ì „ì²´ ë°©ì†¡ í•©ì‚°</option>';
        sources.forEach(src => {
            const opt = document.createElement('option');
            opt.value = src; opt.innerText = src;
            select.appendChild(opt);
        });
        select.value = currentVal;
    }

    function applyFilter() {
        const targetSource = document.getElementById('broadcast-select').value;
        const excludeText = document.getElementById('exclude-input').value;
        const excludeList = excludeText.split(',').map(s => s.trim()).filter(s => s !== "");

        let targetSoop = (targetSource === 'all') ? globalSoop : globalSoop.filter(d => d.source === targetSource);
        runMatching(globalWeflab, targetSoop, targetSource, excludeList);
    }

    function runMatching(weflabList, soopList, filterSource, excludeList) {
        weflabList.sort((a,b) => a.time - b.time);
        soopList.sort((a,b) => a.time - b.time);

        let results = [];
        // ì¤‘ë³µ í—ˆìš©ì„ ìœ„í•´ used í”Œë˜ê·¸ ì œê±°, ì›ë³¸ ë¦¬ìŠ¤íŠ¸ ì°¸ì¡°
        const tolerance = 60 * 1000; // 1ë¶„ í—ˆìš© ì˜¤ì°¨

        weflabList.forEach(roul => {
            // ë§¤ì¹­ ê°€ëŠ¥í•œ ëª¨ë“  í›„ë³´êµ° ê²€ìƒ‰
            const candidates = soopList.filter(g => 
                g.id === roul.id && g.count >= roul.count &&
                Math.abs(g.time - roul.time) <= tolerance
            );

            let status = 'fail';
            let linkedGift = null;
            let failReason = '';

            if (candidates.length > 0) {
                status = 'success';
                // í›„ë³´êµ° ì¤‘ ì‹œê°„ ì°¨ì´ê°€ ê°€ì¥ ì ì€ ê²ƒì„ ì„ íƒ
                linkedGift = candidates.reduce((prev, curr) => 
                    Math.abs(curr.time - roul.time) < Math.abs(prev.time - roul.time) ? curr : prev
                );
            } else {
                // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì›ì¸ ë¶„ì„
                failReason = analyzeFailReason(roul, soopList, tolerance);
            }

            if (filterSource !== 'all') {
                if (status === 'success' && linkedGift.source === filterSource) {
                    results.push({ r: roul, g: linkedGift, status: 'success', source: linkedGift.source });
                }
            } else {
                results.push({ 
                    r: roul, 
                    g: linkedGift, 
                    status: status, 
                    source: linkedGift ? linkedGift.source : '-',
                    failReason: failReason 
                });
            }
        });

        renderDashboard(results, soopList, excludeList);
    }

    function analyzeFailReason(roul, soopList, tolerance) {
        // 1. í•´ë‹¹ íšŒì°¨(ë‚ ì§œ/ì‹œê°„ëŒ€) ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ëŠ”ì§€ ì²´í¬ (ë°©ì†¡ íŒŒì¼ ëˆ„ë½ ê°€ëŠ¥ì„±)
        // ë£°ë › ì‹œê°„ ê¸°ì¤€ ì•ë’¤ 3ì‹œê°„ ë‚´ì— ì–´ë–¤ ë°ì´í„°ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
        const sessionExists = soopList.some(s => Math.abs(s.time - roul.time) <= 3 * 60 * 60 * 1000);
        if (!sessionExists) {
            return "í•´ë‹¹ ë°©ì†¡ íšŒì°¨ ë°ì´í„° ì—†ìŒ (íŒŒì¼ ëˆ„ë½)";
        }

        // 2. í•´ë‹¹ IDì˜ ë‚´ì—­ì´ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš°
        const userRecords = soopList.filter(s => s.id === roul.id);
        if (userRecords.length === 0) return "ë³„í’ì„  ë‚´ì—­ ì—†ìŒ (ID ë¶ˆì¼ì¹˜)";
        
        // 3. ì‹œê°„ ì˜¤ì°¨ ì²´í¬
        const timeMatches = userRecords.filter(s => Math.abs(s.time - roul.time) <= tolerance);
        if (timeMatches.length === 0) {
            const closest = userRecords.reduce((prev, curr) => 
                Math.abs(curr.time - roul.time) < Math.abs(prev.time - roul.time) ? curr : prev
            , userRecords[0]);
            
            if (!closest) return "ì‹œê°„ ì˜¤ì°¨ (ë¹„êµ ëŒ€ìƒ ì—†ìŒ)";

            const diffSec = Math.round((closest.time - roul.time) / 1000);
            return `ì‹œê°„ ì˜¤ì°¨ (${diffSec > 0 ? '+' : ''}${diffSec}ì´ˆ ì°¨ì´)`;
        }

        // 4. ê°œìˆ˜ ë¶ˆì¼ì¹˜ ì²´í¬
        const countMatch = timeMatches.find(s => s.count >= roul.count);
        if (!countMatch) {
            const maxCount = Math.max(...timeMatches.map(c=>c.count));
            return `ê°œìˆ˜ ë¶ˆì¼ì¹˜ (í•„ìš”: ${roul.count}ê°œ, ë‚´ì—­: ${maxCount}ê°œ)`;
        }
        
        return "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
    }

    function renderDashboard(data, filteredSoop, excludeList) {
        // ìš”ì•½
        const successCnt = data.filter(d => d.status === 'success').length;
        
        // 1. ë£°ë › í™•ì • ë³„í’ì„  (ë§¤ì¹­ ì„±ê³µí•œ ê±´ë“¤ì˜ í•©)
        const matchedBalloons = data.reduce((sum, d) => {
            return d.status === 'success' ? sum + d.r.count : sum;
        }, 0);

        // 2. ì „ì²´ ìˆ˜ì§‘ ë³„í’ì„  (íŒŒì¼ì— ìˆëŠ” ëª¨ë“  ë³„í’ì„ )
        const totalBalloons = filteredSoop.reduce((sum, d) => sum + d.count, 0);
        
        document.getElementById('val-total').innerText = data.length.toLocaleString();
        document.getElementById('val-match').innerText = successCnt.toLocaleString();
        document.getElementById('val-miss').innerText = (data.length - successCnt).toLocaleString();
        
        document.getElementById('val-star').innerText = matchedBalloons.toLocaleString();
        document.getElementById('val-star-total').innerText = `(ì „ì²´ ìˆ˜ì§‘: ${totalBalloons.toLocaleString()})`;

        updateTables(data, excludeList);
        updateChart(data);
        updateMatrix(data, excludeList);
    }

    function updateTables(data, excludeList) {
        // 1. ì‚¬ìš©ì í†µê³„ (ë¶„ì„ìš©) - ì œì™¸ í•„í„° ì ìš© X
        const userMap = {};
        const viewerMap = {}; // ë·°ì–´ìš© (ì œì™¸ í•„í„° ì ìš© O)

        data.forEach(d => {
            if(d.status !== 'success') return;
            const uid = d.r.id;
            const item = d.r.result;

            // ë¶„ì„ìš© ë°ì´í„°
            if(!userMap[uid]) userMap[uid] = { nick: d.r.nick, cnt: 0, balloons: 0, wins: {} };
            userMap[uid].cnt++;
            userMap[uid].balloons += d.r.count;
            
            // ìƒì„¸ ë‚´ì—­ ì €ì¥ (ì‹œê°„, ë°©ì†¡ì†ŒìŠ¤)
            if(!userMap[uid].wins[item]) userMap[uid].wins[item] = [];
            userMap[uid].wins[item].push({ t: d.r.time, s: d.source });

            // ë·°ì–´ìš© ë°ì´í„° (ì œì™¸ í•­ëª© ê±´ë„ˆëœ€)
            if (!excludeList.some(ex => item.includes(ex))) {
                if(!viewerMap[uid]) viewerMap[uid] = { nick: d.r.nick, wins: {} };
                viewerMap[uid].wins[item] = (viewerMap[uid].wins[item] || 0) + 1;
            }
        });

        // 1-A. ë¶„ì„ìš© í…Œì´ë¸” ë Œë”ë§
        const userRows = Object.entries(userMap).map(([id, info]) => {
            const badges = Object.entries(info.wins).sort((a,b) => b[1].length - a[1].length)
                .map(([name, logs]) => {
                    // ë¡œê·¸ ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì†ì„±ì— ì €ì¥
                    const logData = JSON.stringify(logs).replace(/"/g, '&quot;');
                    return `<div class="win-badge" style="cursor:pointer" onclick="openDetailModal('${info.nick}', '${name}', '${logData}')">${name}<span class="count">x${logs.length}</span></div>`;
                }).join('');
            
            // ì‹ë³„ í´ë˜ìŠ¤ ë˜í•‘ (col-count, col-star)
            return [
                0, 
                info.nick, 
                id, 
                `<span class="col-count">${info.cnt}</span>`, 
                `<span class="col-star">${info.balloons.toLocaleString()}</span>`, 
                `<div class="win-container">${badges}</div>`
            ];
        }).sort((a,b) => {
            // HTML íƒœê·¸ ì œê±° í›„ ìˆ«ì ì •ë ¬
            const valA = parseInt(a[4].replace(/<[^>]+>/g, '').replace(/,/g, ''));
            const valB = parseInt(b[4].replace(/<[^>]+>/g, '').replace(/,/g, ''));
            return valB - valA;
        });
        
        userRows.forEach((r, i) => r[0] = i+1);
        drawTable('#table-user', userRows);

        // 1-B. ë·°ì–´ìš© í…Œì´ë¸” ë Œë”ë§ (ê°€ë‚˜ë‹¤ìˆœ, ìˆœìœ„/ê¸ˆì•¡ ìˆ¨ê¹€)
        const viewerRows = Object.entries(viewerMap).map(([id, info]) => {
            if(Object.keys(info.wins).length === 0) return null;

            const badges = Object.entries(info.wins).sort((a,b) => b[1]-a[1])
                .map(([name, count]) => {
                    const cntStr = count > 1 ? `<span class="count">${count}</span>` : '';
                    return `<div class="win-badge"><span class="name">${name}</span>${cntStr}</div>`;
                }).join('');
            
            const userHtml = `<div><span class="user-nick">${info.nick}</span><span class="user-id">(${id})</span></div>`;
            return [userHtml, `<div class="win-container">${badges}</div>`, info.nick];
        }).filter(r => r !== null);

        drawTable('#table-viewer', viewerRows, [2, 'asc']); 

        // 2. ë°©ì†¡ë³„ í†µê³„
        const broadcastMap = {};
        
        // 2-1. ë£°ë › ë§¤ì¹­ ë°ì´í„° ì§‘ê³„ (í™•ì • ë³„í’ì„ , íšŸìˆ˜, ìœ ì €)
        data.forEach(d => {
            if(d.status !== 'success') return;
            const src = d.source;
            if(!broadcastMap[src]) broadcastMap[src] = { cnt: 0, users: new Set(), matchedBalloons: 0, totalBalloons: 0 };
            broadcastMap[src].cnt++;
            broadcastMap[src].users.add(d.r.id);
            broadcastMap[src].matchedBalloons += d.r.count;
        });

        // 2-2. ì „ì²´ ìˆ˜ì§‘ ë³„í’ì„  ì§‘ê³„ (globalSoop í™œìš©)
        // í˜„ì¬ ëª©ë¡ì— ìˆëŠ” ë°©ì†¡ ì†ŒìŠ¤ë“¤ì— ëŒ€í•´ì„œë§Œ ì§‘ê³„
        globalSoop.forEach(s => {
            if (broadcastMap[s.source]) {
                broadcastMap[s.source].totalBalloons += s.count;
            }
        });

        const broadcastRows = Object.entries(broadcastMap).map(([src, info]) => [
            src, 
            `<span class="col-count">${info.cnt}</span>`, 
            info.users.size, 
            `<span class="col-star">${info.matchedBalloons.toLocaleString()}</span>`, 
            `<span class="col-star" style="color:#6b7280;">${info.totalBalloons.toLocaleString()}</span>`
        ]);
        drawTable('#table-broadcast', broadcastRows, [3, 'desc']);

        // 3. ë‹¹ì²¨ í†µê³„
        const prizeMap = {};
        let totalSpins = 0;
        data.forEach(d => {
            const p = d.r.result;
            if(!prizeMap[p]) prizeMap[p] = { cnt: 0, sum: 0 };
            prizeMap[p].cnt++;
            prizeMap[p].sum += d.r.count;
            totalSpins++;
        });
        const prizeRows = Object.entries(prizeMap).map(([k, v]) => [
            0, 
            k, 
            `<span class="col-count">${v.cnt}</span>`, 
            ((v.cnt/totalSpins)*100).toFixed(1)+'%', 
            `<span class="col-star">${v.sum.toLocaleString()}</span>`
        ]).sort((a,b) => {
            const valA = parseInt(a[2].replace(/<[^>]+>/g, ''));
            const valB = parseInt(b[2].replace(/<[^>]+>/g, ''));
            return valB - valA;
        });
        prizeRows.forEach((r, i) => r[0] = i+1);
        drawTable('#table-prize', prizeRows);

        // 4. ì „ì²´ ë¡œê·¸
        const detailRows = data.map(d => {
            let statusBadge = '';
            if (d.status === 'success') {
                statusBadge = '<span class="badge bg-green">í™•ì¸ ì™„ë£Œ</span>';
            } else {
                const reason = d.failReason || 'í™•ì¸ í•„ìš”';
                statusBadge = `<span class="badge bg-red" data-tooltip="${reason}">í™•ì¸ í•„ìš”</span>`;
            }
            
            return [
                statusBadge,
                formatTime(d.r.time), 
                d.r.nick, 
                d.r.id, 
                `<span class="col-star">${d.r.count}</span>`, 
                d.r.result, 
                d.source
            ];
        });
        drawTable('#table-detail', detailRows, [1, 'desc']);
    }

    function updateMatrix(data, excludeList) {
        const tableEl = document.getElementById('matrix-table');
        // ë§¤ì¹­ ì„±ê³µí•œ ë°ì´í„°ë§Œ í•„í„°ë§
        const validData = data.filter(d => d.status === 'success');
        
        if (validData.length === 0) {
            tableEl.innerHTML = '<tbody><tr><td style="padding:20px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>';
            return;
        }

        // 1. ë°ì´í„° ì§‘ê³„ ì¤€ë¹„
        const userSet = new Set();
        const itemSet = new Set();
        const counts = {}; // Key: "nick|item", Value: count

        validData.forEach(d => {
            const nick = d.r.nick;
            const item = d.r.result;

            // ì œì™¸ í‚¤ì›Œë“œ í•„í„°ë§ ì ìš© (ë·°ì–´ íƒ­ ì „ìš©)
            if (excludeList && excludeList.some(ex => item.includes(ex))) {
                return; 
            }

            userSet.add(nick);
            itemSet.add(item);
            
            const key = `${nick}|${item}`;
            counts[key] = (counts[key] || 0) + 1;
        });

        // ì •ë ¬ (ìœ ì €ëŠ” ê°€ë‚˜ë‹¤ìˆœ, ì•„ì´í…œë„ ê°€ë‚˜ë‹¤ìˆœ í˜¹ì€ ë¹ˆë„ìˆœ)
        const users = Array.from(userSet).sort();
        const items = Array.from(itemSet).sort();

        // 2. HTML ìƒì„±
        let html = '<thead><tr><th>ìƒí’ˆëª… \\ ë‹‰ë„¤ì„</th>';
        
        // í—¤ë” (ìœ ì € ëª©ë¡)
        users.forEach(u => {
            html += `<th>${u}</th>`;
        });
        html += '<th class="total-cell">í•©ê³„</th></tr></thead><tbody>';

        // ë°”ë”” (ì•„ì´í…œë³„ í–‰)
        const colTotals = new Array(users.length).fill(0); // ì—´ í•©ê³„ ê³„ì‚°ìš©
        let grandTotal = 0;

        items.forEach(item => {
            html += `<tr><th>${item}</th>`; // ì²« ì»¬ëŸ¼ì€ ìƒí’ˆëª…
            
            let rowTotal = 0;
            users.forEach((user, uIdx) => {
                const key = `${user}|${item}`;
                const val = counts[key] || 0;
                
                if (val > 0) {
                    colTotals[uIdx] += val;
                    rowTotal += val;
                    html += `<td>${val}</td>`;
                } else {
                    html += `<td></td>`; // 0ì€ ë¹ˆì¹¸ìœ¼ë¡œ í‘œì‹œ (ê°€ë…ì„± ìœ„í•´)
                }
            });

            grandTotal += rowTotal;
            html += `<td class="total-cell">${rowTotal}</td></tr>`; // í–‰ í•©ê³„
        });

        // í‘¸í„° (ì´í•© í–‰)
        html += '<tr><th>ì´í•©</th>';
        colTotals.forEach(t => {
            html += `<td>${t > 0 ? t : ''}</td>`;
        });
        html += `<td class="total-cell">${grandTotal}</td></tr></tbody>`;

        tableEl.innerHTML = html;
    }

    let chartInstances = {};

    function updateChart(data) {
        // ì´ˆê¸°í™”
        ['pie', 'line', 'bar'].forEach(type => {
            if (chartInstances[type]) {
                chartInstances[type].destroy();
            }
        });

        if (data.length === 0) return;

        // 1. ë°ì´í„° ê°€ê³µ (ì•„ì´í…œë³„ ì¹´ìš´íŠ¸)
        const prizeCnt = {};
        data.forEach(d => prizeCnt[d.r.result] = (prizeCnt[d.r.result]||0)+1);
        const sortedPrizes = Object.entries(prizeCnt).sort((a,b)=>b[1]-a[1]);

        // 2. ì‹œê°„ëŒ€ë³„ ë°ì´í„° ê°€ê³µ (10ë¶„ ë‹¨ìœ„)
        const timeMap = {};
        data.forEach(d => {
            const t = d.r.time;
            // YYYY-MM-DD HH:m0 í˜•ì‹ìœ¼ë¡œ í‚¤ ìƒì„±
            const key = `${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${Math.floor(t.getMinutes()/10)}0`;
            if(!timeMap[key]) timeMap[key] = { label: key, count: 0, timeObj: t };
            timeMap[key].count++;
        });
        const sortedTime = Object.values(timeMap).sort((a,b) => a.timeObj - b.timeObj);

        // --- Chart 1: Pie (Top 10 ë¹„ìœ¨) ---
        const pieCtx = document.getElementById('chart-pie').getContext('2d');
        let pieLabels = [], pieCounts = [];
        if (sortedPrizes.length > 10) {
            pieLabels = sortedPrizes.slice(0,10).map(x=>x[0]);
            pieCounts = sortedPrizes.slice(0,10).map(x=>x[1]);
            pieLabels.push('ê¸°íƒ€');
            pieCounts.push(sortedPrizes.slice(10).reduce((a,b)=>a+b[1],0));
        } else {
            pieLabels = sortedPrizes.map(x=>x[0]);
            pieCounts = sortedPrizes.map(x=>x[1]);
        }
        
        chartInstances['pie'] = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieCounts,
                    backgroundColor: [
                        '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', 
                        '#eab308', '#10b981', '#06b6d4', '#3b82f6', '#64748b', '#94a3b8'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { font: { family: 'Pretendard' }, boxWidth: 12 } } }
            }
        });

        // --- Chart 2: Line (ì‹œê°„ëŒ€ë³„ ì¶”ì´) ---
        const lineCtx = document.getElementById('chart-line').getContext('2d');
        chartInstances['line'] = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: sortedTime.map(x => x.label.split(' ')[1]), // ì‹œê°„ë§Œ í‘œì‹œ
                datasets: [{
                    label: 'ì°¸ì—¬ íšŸìˆ˜',
                    data: sortedTime.map(x => x.count),
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
                    y: { beginAtZero: true, border: { dash: [4, 4] } }
                },
                interaction: { mode: 'index', intersect: false }
            }
        });

        // --- Chart 3: Bar (ì „ì²´ í•­ëª© ìƒì„¸) ---
        // ë°ì´í„° ê°œìˆ˜ì— ë”°ë¼ ë†’ì´ ë™ì  ì¡°ì ˆ
        const barContainer = document.getElementById('chart-bar').parentElement;
        const barData = sortedPrizes.slice(0, 30);
        const dynamicHeight = Math.max(500, barData.length * 30 + 50); // í•­ëª©ë‹¹ 30px + ì—¬ë°±
        barContainer.style.height = `${dynamicHeight}px`;

        const barCtx = document.getElementById('chart-bar').getContext('2d');
        
        chartInstances['bar'] = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: barData.map(x => x[0]),
                datasets: [{
                    label: 'ë‹¹ì²¨ íšŸìˆ˜',
                    data: barData.map(x => x[1]),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 4,
                    barThickness: 'flex',
                    maxBarThickness: 40
                }]
            },
            options: {
                indexAxis: 'y', // ê°€ë¡œí˜• ë§‰ëŒ€
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true },
                    y: { 
                        ticks: { 
                            font: { size: 12, family: 'Pretendard', weight: 600 },
                            autoSkip: false 
                        } 
                    }
                }
            }
        });
    }

    function drawTable(selector, data, order=[0,'asc']) {
        if ($.fn.DataTable.isDataTable(selector)) $(selector).DataTable().destroy();
        
        let columnDefs = [{ className: "dt-center", targets: "_all" }];
        if (selector === '#table-viewer') {
            columnDefs = [
                { className: "dt-center", targets: 0 }, // ì°¸ì—¬ì
                { className: "dt-left", targets: 1 },   // ë‹¹ì²¨ ëª©ë¡ (ì™¼ìª½ ì •ë ¬)
                { visible: false, targets: 2 }          // ì •ë ¬ìš© ìˆ¨ê¹€ ì»¬ëŸ¼
            ];
        }

        $(selector).DataTable({
            data: data, order: [order], pageLength: 25, language: koreanLang,
            autoWidth: false, columnDefs: columnDefs
        });
    }

    function formatTime(d) {
        if(!d) return '-';
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
    }

    window.switchTab = function(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    };

    window.switchViewerMode = function(mode, btn) {
        document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');

        if (mode === 'list') {
            document.getElementById('viewer-view-list').style.display = 'block';
            document.getElementById('viewer-view-matrix').style.display = 'none';
        } else {
            document.getElementById('viewer-view-list').style.display = 'none';
            document.getElementById('viewer-view-matrix').style.display = 'block';
        }
    };

    // ë°©ì†¡ìš© ë·°ì–´ í´ë¦­ ì´ë²¤íŠ¸ (ì œì™¸ í‚¤ì›Œë“œ ì¶”ê°€)
    document.getElementById('table-viewer').addEventListener('click', function(e) {
        // í´ë¦­ëœ ìš”ì†Œê°€ win-badgeì´ê±°ë‚˜ ê·¸ ë‚´ë¶€ ìš”ì†Œì¸ ê²½ìš° ì°¾ê¸°
        const badge = e.target.closest('.win-badge');
        if (!badge) return;

        // ë±ƒì§€ ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸(ìƒí’ˆëª…) ì¶”ì¶œ (count ë“± ì œì™¸)
        // cloneNodeë¥¼ ì‚¬ìš©í•˜ì—¬ ì›ë³¸ í›¼ì† ì—†ì´ ì²˜ë¦¬
        const clone = badge.cloneNode(true);
        // count íƒœê·¸ ì œê±°
        const countSpan = clone.querySelector('.count');
        if (countSpan) countSpan.remove();
        
        const itemName = clone.innerText.trim();
        if (!itemName) return;

        if (confirm(`'${itemName}' í•­ëª©ì„ ë·°ì–´ ì œì™¸ ëª©ë¡ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const input = document.getElementById('exclude-input');
            const currentVal = input.value.trim();
            
            // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬
            const currentList = currentVal.split(',').map(s => s.trim());
            if (currentList.includes(itemName)) {
                alert('ì´ë¯¸ ì œì™¸ ëª©ë¡ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (currentVal) {
                input.value = currentVal + ', ' + itemName;
            } else {
                input.value = itemName;
            }
            
            // í•„í„° ì ìš©
            applyFilter();
        }
    });

    // --- Settings Logic ---
    window.openSettingsModal = function() {
        document.getElementById('settings-modal').classList.add('active');
    };
    window.closeSettingsModal = function() {
        document.getElementById('settings-modal').classList.remove('active');
    };
    window.toggleBlur = function(type, checkbox) {
        if (checkbox.checked) {
            document.body.classList.add(`blur-${type}`);
        } else {
            document.body.classList.remove(`blur-${type}`);
        }
    };
    document.getElementById('settings-modal').addEventListener('click', function(e) {
        if(e.target === this) closeSettingsModal();
    });

    // --- Modal Logic ---
    window.openDetailModal = function(nick, itemName, logDataStr) {
        const logs = JSON.parse(logDataStr);
        const listEl = document.getElementById('modal-list');
        const titleEl = document.getElementById('modal-title');
        
        titleEl.innerHTML = `<span style="color:var(--primary)">${nick}</span>ë‹˜ì˜ '${itemName}' ë‹¹ì²¨ ë‚´ì—­`;
        listEl.innerHTML = '';

        logs.sort((a,b) => new Date(a.t) - new Date(b.t)).forEach((log, idx) => {
            const date = new Date(log.t);
            const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;
            
            const li = document.createElement('li');
            li.className = 'detail-item';
            li.innerHTML = `
                <div>
                    <span class="detail-time">${timeStr}</span>
                    <span class="detail-source"><i class="fas fa-file-csv"></i> ${log.s}</span>
                </div>
                <div style="font-weight:bold; color:#6b7280;">#${idx+1}</div>
            `;
            listEl.appendChild(li);
        });

        document.getElementById('detail-modal').classList.add('active');
    };

    window.closeModal = function() {
        document.getElementById('detail-modal').classList.remove('active');
    };

    window.openToolModal = function() {
        document.getElementById('tool-modal').classList.add('active');
    };

    window.closeToolModal = function() {
        document.getElementById('tool-modal').classList.remove('active');
    };

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('detail-modal').addEventListener('click', function(e) {
        if(e.target === this) closeModal();
    });
    document.getElementById('tool-modal').addEventListener('click', function(e) {
        if(e.target === this) closeToolModal();
    });

    // ë¸”ëŸ¬ ì²˜ë¦¬ëœ ìš”ì†Œ í´ë¦­ ì‹œ ì„¤ì • ëª¨ë‹¬ ì˜¤í”ˆ
    document.body.addEventListener('click', function(e) {
        // 1. ìº¡ìŠ(ë±ƒì§€) ì œì™¸
        if (e.target.closest('.win-badge')) return;

        // 2. í´ë¦­ëœ ìš”ì†Œ ë˜ëŠ” ë¶€ëª¨ ìš”ì†Œ ì¤‘ ë¸”ëŸ¬ í•„í„°ê°€ ì ìš©ëœ ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸
        let target = e.target;
        while (target && target !== document.body) {
            // getComputedStyleë¡œ ì‹¤ì œ ì ìš©ëœ ìŠ¤íƒ€ì¼ í™•ì¸
            const style = window.getComputedStyle(target);
            if (style.filter && style.filter.includes('blur')) {
                openSettingsModal();
                return;
            }
            target = target.parentElement;
        }
    });
</script>
</body>
</html>